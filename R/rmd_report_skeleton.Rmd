---
title: "scPipe_atac report"
author: ""
date: "`r Sys.Date()`"
output: html_document
params:  
  log_and_stats_folder: folder
editor_options: 
  chunk_output_type: console
---
```{r}

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(dplyr)
library(readr) 
library(ggplot2)
library(kableExtra)
library(RColorBrewer)
library(grid)
library(knitr)
library(stringr)
theme_set(theme_bw())

```

## Global quality statistics

```{r}
trimbarcode_stats_filename    <- paste0(params$log_and_stats_folder, "/stats_file_trimbarcode.txt")
trimbarcode_stats             <- readr::read_csv(trimbarcode_stats_filename, col_names = FALSE) %>% as.data.frame() 
trimbarcode_stats             <- stringr::str_replace_all(trimbarcode_stats[,1], "\\: +", "\\,") %>% as.data.frame()
trimbarcode_stats             <- stringr::str_split_fixed(trimbarcode_stats[,1], ",", n=2) %>%
  as.data.frame()

knitr::kable(trimbarcode_stats, 
             col.names = c('Statistic', 'Value'), 
             caption = "Global quality statistics")
```

## Alignment statistics

```{r}
alignment_stats_filename <- paste0(params$log_and_stats_folder, "/stats_file_align.txt")
alignment_stats          <- readr::read_csv(alignment_stats_filename)
knitr::kable(alignment_stats, 
             col.names = c('Statistic', 'Value'), 
             caption = "Global alignment statistics")
```

## Alignment statistics per chromosome

```{r}
alignment_stats_chrom_filename <- paste0(params$log_and_stats_folder, "/stats_file_align_per_chrom.csv")
alignment_stats_chrom          <- readr::read_csv(alignment_stats_chrom_filename)
knitr::kable(alignment_stats_chrom, 
             col.names = c('Chromosome', 'Chrom_length', 'Mapped_reads', "Unmapped_reads"), 
             caption = "Chromosome level alignment statistics")
```

## Read count distribution across barcodes

```{r}

n_reads_barcode_filename    <- paste0(params$log_and_stats_folder, "/number_of_reads_per_barcode.csv")
number_of_reads_per_barcode <- readr::read_csv(n_reads_barcode_filename)

head(number_of_reads_per_barcode)

```

```{r}
number_of_reads_per_barcode %>% 
  ggplot() +
  geom_histogram(aes(log2(number_of_reads))) + theme_bw()
```

## Per cell statistics

```{r}
cell_stats    <- readr::read_csv(paste0(params$log_and_stats_folder, "/filtered_stats_per_cell.csv"))
```

Figures \@ref(fig:percell-counts) and \@ref(fig:percell-features) 

```{r percell-counts, fig.wide = TRUE, fig.cap = sprintf("Counts per cell", chosen), fig.asp = 0.9}
cell_stats$log_counts_per_cell <- log(cell_stats$counts_per_cell+1)

ggpubr::gghistogram(cell_stats,
                    x = "log_counts_per_cell",
                    y = "..count..",
                    title = "Counts per cell",
                    color = "#00AFBB", 
                    fill = "#00AFBB",
                    bins = 10,
                    rug = TRUE,
                    add = "mean",
                    add_density = TRUE
                    )
# plot_grid( ,ncol = 2, align = "v")
# hist(log(cell_stats$counts_per_cell+1),main='Counts per cell',col='black')
```

```{r percell-features, fig.wide = TRUE, fig.cap = sprintf("Features per cell", chosen), fig.asp = 0.9}

cell_stats$log_features_per_cell <- log(cell_stats$features_per_cell+1)

ggpubr::gghistogram(cell_stats,
                    x = "log_features_per_cell",
                    y = "..count..",
                    title = "Features per cell",
                    color = "#00AFBB", 
                    fill = "#00AFBB",
                    bins = 10,
                    rug = TRUE,
                    add = "mean",
                    add_density = TRUE
                    )

#hist(log(cell_stats$features_per_cell+1), main='Features per cell', col='black')
```

# Per feature statistics

```{r}
feature_stats <- readr::read_csv(paste0(params$log_and_stats_folder, "/filtered_stats_per_feature.csv"))
```

```{r perfeature-counts, fig.wide = TRUE, fig.cap = sprintf("Counts per feature", chosen), fig.asp = 0.9}

feature_stats$log_counts_per_feature <- log(feature_stats$counts_per_feature+1)

ggpubr::gghistogram(feature_stats,
                    x = "log_counts_per_feature",
                    y = "..count..",
                    title = "Counts per feature",
                    color = "#E7B800", 
                    fill = "#E7B800",
                    bins = 10,
                    rug = TRUE,
                    add = "mean",
                    add_density = TRUE
                    )

#hist(log(feature_stats$counts_per_feature+1), main='counts per feature', col='black')
```

```{r perfeature-cells, fig.wide = TRUE, fig.cap = sprintf("Cells per feature", chosen), fig.asp = 0.9}

feature_stats$log_cells_per_feature <- log(feature_stats$cells_per_feature+1)

ggpubr::gghistogram(feature_stats,
                    x = "log_cells_per_feature",
                    y = "..count..",
                    title = "Cells per feature",
                    color = "#E7B800", 
                    fill = "#E7B800",
                    bins = 10,
                    rug = TRUE,
                    add = "mean",
                    add_density = TRUE
                    )

#hist(log(feature_stats$cells_per_feature+1), main='counts per feature', col='black')
```

```{r corr-cells, fig.wide = TRUE, fig.cap = sprintf("Counts vs features per cell", chosen), fig.asp = 0.9}
ggpubr::ggscatter(cell_stats,
                  x = "log_counts_per_cell",
                  y = "log_features_per_cell",
                  title = "Relationship between counts and features per cell",
                  color = "#00AFBB", 
                  fill = "#00AFBB", 
                  add = "reg.line",
                  conf.int = TRUE, # Add confidence interval
                  cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
                  cor.coeff.args = list(method = "spearman", label.x = 1, label.sep = "\n"),
                  rug = TRUE)

# plot(cell_stats$counts_per_cell, cell_stats$features_per_cell, log='xy', col='black')
# title('counts vs features per cell')
```

```{r corr-features, fig.wide = TRUE, fig.cap = sprintf("Counts vs cells per feature", chosen), fig.asp = 0.9}
ggpubr::ggscatter(feature_stats,
                  x = "log_counts_per_feature",
                  y = "log_cells_per_feature",
                  title = "Relationship between counts and cells per feature",
                  color = "#E7B800", 
                  fill = "#E7B800", 
                  add = "reg.line",
                  conf.int = TRUE, # Add confidence interval
                  cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
                  cor.coeff.args = list(method = "spearman", label.x = 1, label.sep = "\n"),
                  rug = TRUE)
```

```{r}
plot(sort(cell_stats$features_per_cell), xlab='cell', log='y', ylab ="features", main='features per cell (ordered)')
```

# QC plots

```{r}
frags_file <- here::here("scPipe-atac-output", "fragments.bed")
peaks_file <- here::here("scPipe-atac-output", "NA_peaks.narrowPeak")
promoters_file <- here::here("inst", "extdata", "annotations", "hg38_promoter.bed")
tss_file <- here::here("inst", "extdata", "annotations", "hg38_tss.bed")
enhs_file <- here::here("inst", "extdata", "annotations", "hg38_enhancer.bed")
qc_per_bc_file <- here::here("scPipe-atac-output", "qc_per_bc_file.txt")

frags <- fread(frags_file)
head(frags)

nrow(frags)
sum(frags$V5)

# read in qc_per_bc file
bc_stat <- fread(qc_per_bc_file)
head(bc_stat)
nrow(bc_stat)
sum(bc_stat$total_frags)

# read in called cellular barcodes
cell_barcode_file <- here("scPipe-atac-output", "non_empty_barcodes.txt")
cell_barcodes <- fread(cell_barcode_file, header=F)$V1

qc_sele <- bc_stat[bc %in% cell_barcodes, ]
qc_nonsele <- bc_stat[!bc %in% cell_barcodes, ]
```

## PLOT 1 Total fragments VS fraction in peaks

```{r}
bc_stat[, 'group' := ifelse(bc %in% cell_barcodes, 'cell', 'non-cell')]

nsub_frags = min(15000, nrow(bc_stat))  ## downsample for scatter plot
bc_stat_down = bc_stat[sort(sample(1:nrow(bc_stat), nsub_frags)), ]
g <- ggplot(data = bc_stat_down, 
            aes(x = total_frags, y = frac_peak, col = group)) + 
  geom_point(size = 0.5) + scale_x_continuous(trans='log10') + theme_bw() +
  theme(legend.position = 'none', 
        legend.title=element_blank(),
        axis.text = element_text(size = 15, family = "Helvetica"),
        axis.title = element_text(size = 18, family = "Helvetica")) +
  xlab('Total #Unique Fragments') + ylab('Fraction in Peak')

text1 <- grobTree(textGrob("Cell", x=0.8,  y=0.93, hjust=0,
                           gp=gpar(col='#1F78B4', fontsize=15, fontface = 'bold', fontfamily = "Helvetica")))
text2 <- grobTree(textGrob("Non-cell", x=0.8,  y=0.83, hjust=0,
                           gp=gpar(col='#B2DF8A', fontsize=15, fontface = 'bold', fontfamily = "Helvetica")))

g + annotation_custom(text1) + annotation_custom(text2) + scale_color_manual(values = c('#1F78B4', '#B2DF8A'))
```

## PLOT 2 Distribution of Insert Size

```{r}
  frags[, 'isize' := V3 - V2]
  if (nrow(frags) >= 100000) {
    frags = frags[sort(sample(1:nrow(frags), 100000)), ]
  }
  
  ggplot(data = frags[isize < 800], aes(x = isize)) +
    geom_density(fill = 'lightblue') + xlab('Insert Size') + ylab('Density') + theme_bw() +  theme(legend.title=element_blank(), 
                                                                                                   legend.background = NULL, 
                                                                                                   axis.text = element_text(size = 15, family = "Helvetica"), 
                                                                                                   axis.title = element_text(size = 18, family = "Helvetica"))
```

## PLOT 3 Density plot of total number of unique fragments

```{r}
bc_stat[, 'group' := ifelse(bc %in% cell_barcodes, 'cell', 'non-cell')]

p <- ggplot(data = bc_stat, aes(x = total_frags, fill = group)) + 
  geom_density() + scale_x_continuous(trans = 'log10') + theme_bw() +
  theme(legend.position='none', legend.title=element_blank(),
        axis.title = element_text(size = 18, family = "Helvetica"),
        axis.text = element_text(size = 15, family = "Helvetica")) + 
  xlab('Total #Unique Fragments') + ylab('Density') 

text1 <- grobTree(textGrob("Cell", x=0.8,  y=0.93, hjust=0,
                           gp=gpar(col='#1F78B4', fontsize=15, fontface = 'bold', fontfamily = "Helvetica")))
text2 <- grobTree(textGrob("Non-cell", x=0.8,  y=0.83, hjust=0,
                           gp=gpar(col='#B2DF8A', fontsize=15, fontface = 'bold', fontfamily = "Helvetica")))

p + annotation_custom(text1) + annotation_custom(text2) +
  scale_fill_manual(values = c('#1F78B4', '#B2DF8A'))
```

## PLOT 4 Overlapping with sequence annotated regions

```{r}
qc_sele_df = data.table(frac = c(qc_sele$frac_peak, qc_sele$frac_tss, qc_sele$frac_promoter, qc_sele$frac_enh, qc_sele$frac_mito), 'type' = rep(c('Peaks', 'Tss', 'Promoter', 'Enhancer', 'Mito'), each = nrow(qc_sele)))
  
qc_sele_df$type = factor(qc_sele_df$type, levels = c('Peaks', 'Tss', 'Promoter', 'Enhancer', 'Mito'))

ggplot(data = qc_sele_df, aes(y = frac, x = type, fill = type)) + ylab('Fraction') + theme_bw() +
  geom_boxplot(outlier.size = 0.01, show.legend = FALSE) + 
  scale_fill_manual(values = brewer.pal(5, 'Paired')) +
  theme(legend.position = 'none', 
        axis.text = element_text(size = 18, family = "Helvetica"), 
        axis.title.x = element_blank(), 
        axis.title.y = element_text(size = 18, family = "Helvetica")) + xlab('') 
```

## Overall statistics (fraction in peaks, promoters, enhancers, TSS)

```{r}
frac_peak = sum(qc_sele$total_frags * qc_sele$frac_peak)/sum(qc_sele$total_frags)
frac_mito = sum(qc_sele$total_frags * qc_sele$frac_mito)/sum(qc_sele$total_frags)
frac_promoter = sum(qc_sele$total_frags * qc_sele$frac_promoter)/sum(qc_sele$total_frags)
frac_enh = sum(qc_sele$total_frags * qc_sele$frac_enhancer)/sum(qc_sele$total_frags)
frac_tss = sum(qc_sele$total_frags * qc_sele$frac_tss)/sum(qc_sele$total_frags)

fracs = data.frame(c(frac_peak,  frac_promoter, frac_enh, frac_tss))
row.names(fracs) = c('Fraction in peaks', 
                     'Fraction in promoters', 'Fraction in Enhancers(ENCODE)', 
                     'Fraction in TSS')
colnames(fracs) = 'pr'
fracs$pr = round(fracs$pr, 3)
fracs$pr = paste0(100*fracs$pr, '%')

kable(fracs, row.names = T, col.names = NULL) %>%
  kable_styling(full_width = F, position = 'left', font_size = 15)
```

